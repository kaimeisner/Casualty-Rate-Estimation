<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Casualty Estimation Calculator</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 2rem; }
    #result { font-size: 2rem; font-weight: bold; color: #0066cc; }
    .dropdown-item { cursor: pointer; }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="text-center mb-4">Casualty Estimation Calculator</h1>
	<p class="text-center text-muted">The model is based on Edwin D’Souza et al.: Forecasting Wounded-In-Action Casualty Rates for Ground Combat Operations (2019).</p>
    <p class="text-center text-muted">Select tactical parameters to compute the casualty estimation.</p>
    <div class="row mb-3">
      <div class="col-md-6">
        <label class="form-label">Population at Risk</label>
        <input type="number" id="par" class="form-control" step="1" value="1000" min="0" max="100000000000000000"
               title="Adjustment factor for mission-specific variables (e.g., intel quality, morale)">
      </div>
      <div class="col-md-6">
        <label class="form-label">Duration (Days)</label>
        <input type="number" id="duration_days" class="form-control" value="1" min="1" max="90"
               title="Length of operation in days (affects fatigue, logistics)">
      </div>
    </div>
    <div class="row mb-3">
      <div class="col-md-6">
        <label class="form-label">Tactical Operation</label>
        <select id="tactical_operation" class="form-select">
          <option value="offensive">Offensive</option>
          <option value="stability">Stability</option>
          <option value="sustainment">Sustainment</option>
          <option value="counterinsurgency">Counterinsurgency</option>
          <option value="defensive">Defensive</option>
          <option value="peace_operations">Peace Operations</option>
        </select>
      </div>
      <div class="col-md-6">
        <label class="form-label">Posture</label>
        <select id="posture" class="form-select">
          <option value="attacker">Attacker</option>
          <option value="defender">Defender</option>
        </select>
      </div>
    </div>
    <div class="row mb-3">
      <div class="col-md-6">
        <label class="form-label">Climate</label>
        <select id="climate" class="form-select">
          <option value="temperate">Temperate</option>
          <option value="hot">Hot</option>
          <option value="cold">Cold</option>
        </select>
      </div>
      <div class="col-md-6">
        <label class="form-label">Terrain</label>
        <select id="terrain" class="form-select">
          <option value="urban">Urban</option>
          <option value="rolling">Rolling</option>
          <option value="flat">Flat</option>
          <option value="swamp">Swamp</option>
          <option value="rugged">Rugged</option>
        </select>
      </div>
    </div>
    <div class="row mb-3">
      <div class="col-md-6">
        <label class="form-label">Enemy Capability</label>
        <select id="enemy_capability" class="form-select">
          <option value="near_peer">Near-Peer</option>
          <option value="hybrid">Hybrid</option>
          <option value="failed_state">Failed State</option>
          <option value="asymmetric">Asymmetric</option>
        </select>
      </div>
      <div class="col-md-6">
        <label class="form-label">Tactical Action</label>
        <select id="tactical_action" class="form-select">
          <!-- Defensive -->
          <option value="blue_counterattack_heavy_resistance">Defensive: Blue Counterattack (Heavy Resistance)</option>
          <option value="red_attack">Defensive: Red Attack</option>
          <option value="blue_counterattack_light_resistance">Defensive: Blue Counterattack (Light Resistance)</option>
          <option value="patrolling">Defensive: Patrolling</option>
          <!-- Offensive -->
          <option value="amphibious_assault">Offensive: Amphibious Assault</option>
          <option value="blue_attack_heavy_resistance">Offensive: Blue Attack (Heavy Resistance)</option>
          <option value="airdrop_attack">Offensive: Airdrop Attack</option>
          <option value="assault_river_crossing">Offensive: Assault / River Crossing</option>
        </select>
      </div>
    </div>
    <div class="row mb-4">
      <div class="col-md-6">
        <label class="form-label">Operational Environment</label>
        <select id="operational_environment" class="form-select">
          <option value="close_area_near_peer">Close Area / Near-Peer</option>
          <option value="close_area_hybrid">Close Area / Hybrid</option>
          <option value="close_area_failed_state">Close Area / Failed State</option>
          <option value="close_area_asymmetric">Close Area / Asymmetric</option>
          <option value="support_area_forward_peer">Support Area Forward / Near-Peer</option>
          <option value="support_area_forward_hybrid">Support Area Forward / Hybrid</option>
          <option value="support_area_forward_failed_state">Support Area Forward / Failed State</option>
          <option value="support_area_forward_asymmetric">Support Area Forward / Asymmetric</option>
          <option value="support_area_rear_peer">Support Area Rear / Near-Peer</option>
          <option value="support_area_rear_hybrid">Support Area Rear / Hybrid</option>
          <option value="support_area_rear_failed_state">Support Area Rear / Failed State</option>
          <option value="support_area_rear_asymmetric">Support Area Rear / Asymmetric</option>
        </select>
      </div>
    </div>
    <div class="text-center mb-4">
      <button id="calculate" class="btn btn-primary btn-lg">Calculate Combat Advantage</button>
    </div>
    <div class="text-center">
      <h2>Result: <span id="result">--</span></h2>
    </div>
  </div>

  <script>
    const tacticalOperationDict = {
      "offensive": 0,
      "stability": -0.3832,
      "sustainment": -0.4818,
      "counterinsurgency": -0.5727,
      "defensive": -1.0436,
      "peace_operations": -3.0000
    };

    const postureDict = {
      "attacker": 0,
      "defender": 1.1864
    };

    const climateDict = {
      "temperate": 0,
      "hot": -0.0072,
      "cold": -0.3233
    };

    const terrainDict = {
      "urban": 0,
      "rolling": -0.0060,
      "flat": -0.1289,
      "swamp": -0.3504,
      "rugged": -0.4060
    };

    const enemyCapabilityDict = {
      "near_peer": 0,
      "hybrid": -0.2095,
      "failed_state": -0.7422,
      "asymmetric": -0.7422
    };

    const tacticalActionDict = {
      // Defensive
      "blue_counterattack_heavy_resistance": 1.651,
      "red_attack": 1.463,
      "blue_counterattack_light_resistance": 0.979,
      "patrolling": 0.603,
      // Offensive
      "amphibious_assault": 2.582,
      "blue_attack_heavy_resistance": 2.278,
      "airdrop_attack": 1.912,
      "assault_river_crossing": 1.610
    };

    const operationalEnvironmentDict = {
      "close_area_near_peer": 1,
      "close_area_hybrid": 1,
      "close_area_failed_state": 1,
      "close_area_asymmetric": 1,
      "support_area_forward_peer": 0.188,
      "support_area_forward_hybrid": 0.209,
      "support_area_forward_failed_state": 0.257,
      "support_area_forward_asymmetric": 0.459,
      "support_area_rear_peer": 0.070,
      "support_area_rear_hybrid": 0.090,
      "support_area_rear_failed_state": 0.135,
      "support_area_rear_asymmetric": 0.310
    };

    const combatAdvantageDict = {
      "neutral": "neutral",
      "blue_advantage_near_peer": "blue_advantage_near_peer",
      "blue_advantage_other": "blue_advantage_other",
      "red_advantage_near_peer": "red_advantage_near_peer",
      "red_advantage_other": "red_advantage_other"
    };

    function exponentialPercentile(mean, p) {
      if (p < 0 || p > 1) throw new Error("p must be between 0 and 1");
      if (mean <= 0) throw new Error("mean must be positive");
      return -mean * Math.log(1 - p);
    }

    // Gamma distribution percentile using approximation (since we don't have scipy)
    // We'll use a simple approximation for shape=1 (which is exponential) and a reasonable approximation for other shapes
    function gammaPercentile(mean, p, shape = 1) {
      if (p < 0 || p > 1) throw new Error("p must be between 0 and 1");
      if (mean <= 0) throw new Error("mean must be positive");
      if (shape <= 0) throw new Error("shape must be positive");

      // For shape=1, gamma is exponential
      if (shape === 1) {
        return exponentialPercentile(mean, p);
      }

      // For other shapes, use Wilson-Hilferty approximation for gamma distribution
      // This is an approximation: gamma(shape, scale) ≈ normal with mean and variance adjusted
      // We use the approximation: (X/shape)^(1/3) ≈ N(1 - 2/(9*shape), 2/(9*shape))
      const scale = mean / shape;
      const z = inverseNormalCDF(p); // Standard normal quantile
      const adjusted = Math.pow((1 - 2/(9*shape) + z * Math.sqrt(2/(9*shape))), 3);
      return scale * shape * adjusted;
    }

    // Inverse Normal CDF (Probit function) approximation using Beasley-Springer-Moro algorithm
    function inverseNormalCDF(p) {
      if (p <= 0 || p >= 1) throw new Error("p must be strictly between 0 and 1");
      
      const a1 = -3.969683028665376e+01;
      const a2 =  2.209460984245205e+02;
      const a3 = -2.759285104469687e+02;
      const a4 =  1.383577518672690e+02;
      const a5 = -3.066479806614716e+01;
      const a6 =  2.506628277459239e+00;
      
      const b1 = -5.447609879822406e+01;
      const b2 =  1.615858368580409e+02;
      const b3 = -1.556989798598866e+02;
      const b4 =  6.680131188771972e+01;
      const b5 = -1.328068155288572e+01;
      
      const c1 = -7.784894002430293e-03;
      const c2 = -3.223964580411365e-01;
      const c3 = -2.400758277161838e+00;
      const c4 = -2.549732539343734e+00;
      const c5 =  4.374664141464968e+00;
      const c6 =  2.938163982698783e+00;
      
      const d1 = 7.784695709041462e-03;
      const d2 = 3.224671290700398e-01;
      const d3 = 2.445134137142996e+00;
      const d4 = 3.754408661907416e+00;
      
      // Define low and high bounds for approximation regions
      const p_low = 0.02425;
      const p_high = 1 - p_low;
      
      let q, r;
      
      if (p < p_low) {
        q = Math.sqrt(-2 * Math.log(p));
        return (((((c1*q + c2)*q + c3)*q + c4)*q + c5)*q + c6) / ((((d1*q + d2)*q + d3)*q + d4)*q + 1);
      } else if (p <= p_high) {
        q = p - 0.5;
        r = q * q;
        return (((((a1*r + a2)*r + a3)*r + a4)*r + a5)*r + a6) * q / (((((b1*r + b2)*r + b3)*r + b4)*r + b5)*r + 1);
      } else {
        q = Math.sqrt(-2 * Math.log(1 - p));
        return -(((((c1*q + c2)*q + c3)*q + c4)*q + c5)*q + c6) / ((((d1*q + d2)*q + d3)*q + d4)*q + 1);
      }
    }

    // Calculate ln(WIA) 
    function getLnWia(par, durationDays, tacticalOperation, posture, climate, terrain, enemyCapability, intercept = 4.0986) {
      const logPar = par > 0 ? Math.log(par) : 0;
      const logDuration = durationDays > 0 ? Math.log(durationDays) : 0;
      
      return intercept + 
             (-0.1577) * logPar + 
             (-0.4630) * logDuration +
             (tacticalOperationDict[tacticalOperation] || 0) +
             (postureDict[posture] || 0) +
             (climateDict[climate] || 0) +
             (terrainDict[terrain] || 0) +
             (enemyCapabilityDict[enemyCapability] || 0);
    }

    // Calculate mean WIA 
    function getMeanWia(par, durationDays, tacticalOperation, posture, climate, terrain, enemyCapability, tacticalAction, operationalEnvironment, intercept = 4.0986, combatAdvantage = "neutral") {
      // Calculate base mean
      const lnWia = getLnWia(par, durationDays, tacticalOperation, posture, climate, terrain, enemyCapability, intercept);
      let mean = Math.exp(lnWia);
      
      // Apply tactical action multiplier
      const tacticalMultiplier = tacticalActionDict[tacticalAction] || 1;
      mean *= tacticalMultiplier;
      
      // Apply operational environment multiplier
      const opEnvMultiplier = operationalEnvironmentDict[operationalEnvironment] || 1;
      mean *= opEnvMultiplier;
      
      // Apply combat advantage adjustment
      switch (combatAdvantage) {
        case "neutral":
          return mean;
        case "blue_advantage_near_peer":
          return exponentialPercentile(mean, 0.5);
        case "blue_advantage_other":
          return gammaPercentile(mean, 0.5);
        case "red_advantage_near_peer":
          return exponentialPercentile(mean, 0.8);
        case "red_advantage_other":
          return exponentialPercentile(mean, 0.8);
        default:
          return mean;
      }
    }

    // Initialize on page load
    document.addEventListener("DOMContentLoaded", function() {
      // Add event listener to calculate button
      document.getElementById("calculate").addEventListener("click", function() {
        // Get input values
        const par = parseFloat(document.getElementById("par").value) || 0;
        const durationDays = parseInt(document.getElementById("duration_days").value) || 1;
        const tacticalOperation = document.getElementById("tactical_operation").value;
        const posture = document.getElementById("posture").value;
        const climate = document.getElementById("climate").value;
        const terrain = document.getElementById("terrain").value;
        const enemyCapability = document.getElementById("enemy_capability").value;
        const tacticalAction = document.getElementById("tactical_action").value;
        const operationalEnvironment = document.getElementById("operational_environment").value;
        
        const combatAdvantage = "neutral";
        
        // Calculate result
        try {
          const result = getMeanWia(par, durationDays, tacticalOperation, posture, climate, terrain, enemyCapability, tacticalAction, operationalEnvironment, 4.0986, combatAdvantage);
          document.getElementById("result").textContent = result.toFixed(4);
        } catch (error) {
          document.getElementById("result").textContent = "Error: " + error.message;
        }
      });
    });
  </script>
</body>
</html>